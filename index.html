<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Camera System - Red Spider Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            background-color: #f5f5f5;
        }
        .camera-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        .camera-feed {
            width: 100%;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-online {
            background-color: #28a745;
        }
        .status-offline {
            background-color: #dc3545;
        }
        .status-card {
            height: 100%;
        }
        .detection-alert {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: none;
        }
        .relay-button {
            width: 100%;
            margin-bottom: 10px;
        }
        .relay-on {
            background-color: #28a745;
            border-color: #28a745;
        }
        .relay-off {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        h1 {
            margin-bottom: 30px;
            color: #343a40;
        }
        .last-updated {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">ESP32 Camera System - Red Spider Detection</h1>
        
        <div class="alert alert-danger detection-alert" id="detection-alert">
            <strong>ALERT!</strong> Red spider detected! Check camera feeds.
        </div>
        
        <div class="row">
            <!-- Camera Feeds -->
            <div class="col-md-8">
                <div class="row">
                    <!-- Camera 1 -->
                    <div class="col-md-6">
                        <div class="camera-container">
                            <h4>
                                <span class="status-indicator status-online" id="camera1-status"></span>
                                Camera 1
                            </h4>
                            <img src="/video_feed/1" class="camera-feed" id="camera1-feed">
                            <div class="last-updated" id="camera1-updated">Last update: Never</div>
                        </div>
                    </div>
                    
                    <!-- Camera 2 -->
                    <div class="col-md-6">
                        <div class="camera-container">
                            <h4>
                                <span class="status-indicator status-online" id="camera2-status"></span>
                                Camera 2
                            </h4>
                            <img src="/video_feed/2" class="camera-feed" id="camera2-feed">
                            <div class="last-updated" id="camera2-updated">Last update: Never</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status and Controls -->
            <div class="col-md-4">
                <!-- System Status -->
                <div class="camera-container status-card">
                    <h4>System Status</h4>
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td>Camera 1</td>
                                <td><span id="camera1-detection-status">No Detection</span></td>
                            </tr>
                            <tr>
                                <td>Camera 2</td>
                                <td><span id="camera2-detection-status">No Detection</span></td>
                            </tr>
                            <tr>
                                <td>Last Detection</td>
                                <td id="last-detection-time">Never</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">Relay Controls</h4>
                    <div class="d-grid gap-2">
                        <button class="btn relay-button relay-off" id="relay1-btn" onclick="toggleRelay(1)">
                            Relay 1: OFF
                        </button>
                        <button class="btn relay-button relay-off" id="relay2-btn" onclick="toggleRelay(2)">
                            Relay 2: OFF
                        </button>
                        <button class="btn relay-button relay-off" id="relay3-btn" onclick="toggleRelay(3)">
                            Relay 3: OFF
                        </button>
                        <button class="btn relay-button relay-off" id="relay4-btn" onclick="toggleRelay(4)">
                            Relay 4: OFF
                        </button>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-primary" onclick="updateStatus()">
                            Refresh Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let relayStates = {1: false, 2: false, 3: false, 4: false};
        let lastDetectionTime = null;
        
        // Update status on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            // Refresh status every 5 seconds
            setInterval(updateStatus, 5000);
        });
        
        // Update system status
        function updateStatus() {
            // Update detection status
            fetch('/api/detection/status')
                .then(response => response.json())
                .then(data => {
                    updateDetectionStatus(data);
                })
                .catch(error => console.error('Error fetching detection status:', error));
            
            // Update relay status
            fetch('/api/relay/status')
                .then(response => response.json())
                .then(data => {
                    updateRelayStatus(data);
                })
                .catch(error => console.error('Error fetching relay status:', error));
        }
        
        // Update detection status display
        function updateDetectionStatus(data) {
            let anyDetection = false;
            
            // Update Camera 1
            if (data[1]) {
                const camera1Detected = data[1].detected;
                const camera1Confidence = data[1].confidence;
                
                document.getElementById('camera1-detection-status').textContent = 
                    camera1Detected ? `DETECTED (${(camera1Confidence * 100).toFixed(1)}%)` : 'No Detection';
                
                if (camera1Detected) {
                    document.getElementById('camera1-detection-status').className = 'text-danger fw-bold';
                    anyDetection = true;
                    lastDetectionTime = new Date();
                } else {
                    document.getElementById('camera1-detection-status').className = 'text-success';
                }
            }
            
            // Update Camera 2
            if (data[2]) {
                const camera2Detected = data[2].detected;
                const camera2Confidence = data[2].confidence;
                
                document.getElementById('camera2-detection-status').textContent = 
                    camera2Detected ? `DETECTED (${(camera2Confidence * 100).toFixed(1)}%)` : 'No Detection';
                
                if (camera2Detected) {
                    document.getElementById('camera2-detection-status').className = 'text-danger fw-bold';
                    anyDetection = true;
                    lastDetectionTime = new Date();
                } else {
                    document.getElementById('camera2-detection-status').className = 'text-success';
                }
            }
            
            // Show/hide detection alert
            document.getElementById('detection-alert').style.display = anyDetection ? 'block' : 'none';
            
            // Update last detection time
            if (lastDetectionTime) {
                document.getElementById('last-detection-time').textContent = lastDetectionTime.toLocaleString();
            }
        }
        
        // Update relay status display
        function updateRelayStatus(data) {
            relayStates = data;
            
            for (let relay = 1; relay <= 4; relay++) {
                const isOn = data[relay];
                const button = document.getElementById(`relay${relay}-btn`);
                
                button.textContent = `Relay ${relay}: ${isOn ? 'ON' : 'OFF'}`;
                
                if (isOn) {
                    button.classList.remove('relay-off');
                    button.classList.add('relay-on');
                } else {
                    button.classList.remove('relay-on');
                    button.classList.add('relay-off');
                }
            }
        }
        
        // Toggle relay state
        function toggleRelay(relayId) {
            // Toggle state
            const newState = !relayStates[relayId];
            
            // Prepare data for API
            const data = {};
            data[`relay${relayId}`] = newState;
            
            // Send request to API
            fetch('/api/relay/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Relay updated:', data);
                updateStatus();
            })
            .catch(error => {
                console.error('Error updating relay:', error);
                alert('Failed to update relay state.');
            });
        }
        
        // Handle camera stream errors
        function handleStreamError(cameraId) {
            document.getElementById(`camera${cameraId}-status`).classList.remove('status-online');
            document.getElementById(`camera${cameraId}-status`).classList.add('status-offline');
        }
    </script>
</body>
</html>